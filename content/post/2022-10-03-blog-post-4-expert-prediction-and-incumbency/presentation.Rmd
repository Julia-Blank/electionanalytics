---
title: "Presentation"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
#LOAD IN REQUISITE DATA SETS
expert_ratings <- read_csv("04-Incumbency-9-29-/Section-data/District-level-forecast/expert_rating.csv")
historical_results <- read_csv("04-Incumbency-9-29-/Section-data/District-level-forecast/house party vote share by district 1948-2020.csv") %>%
  clean_names()
incumb_dist_1948_2022_2_ <- read_csv("04-Incumbency-9-29-/Section-data/incumb_dist_1948-2022 (2).csv")
roper_cong_polls_1979_2022 <- read_csv("04-Incumbency-9-29-/roper_cong_polls_1979-2022.csv")
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
#find data for the democrats from historical results
# Selecting columns
avg_ratings <- expert_ratings %>% 
  select(year, state, district, avg_rating)


historical_results_clean <- historical_results %>%
  mutate(dem_status = case_when(dem_status == "Incumbent" ~ 1,
                               TRUE ~ 0),
         rep_status = case_when(rep_status == "Incumbent" ~ 1,
                               TRUE ~ 0))
  
dem_results <- historical_results_clean %>% 
  select(race_year, state, area, dem_votes_major_percent, dem_status) %>% 
  rename("year" = "race_year") %>% 
  separate(area, into = c("area", "district"), sep = " ") %>% 
  select(-area) %>% 
  mutate(district = case_when(
    district == "Large" ~ "AL",
    TRUE ~ district))


# Joining the data and nesting by state and district
train_data_dem <- avg_ratings %>% 
  filter(year != 2022) %>% 
  # left join as there aren't ratings for every district
  left_join(dem_results, by = c("year", "state", "district")) %>% 
  group_by(state, district) %>% 
  filter(n() > 1) %>% # Filtering out single data rows
  group_nest() %>% 
  mutate(data = map(data, ~unnest(., cols = c())))


```

```{r}
modelsdem <- train_data_dem %>% 
  mutate(modeldem = map(data, ~lm(dem_votes_major_percent ~ avg_rating + dem_status, 
                                  data = .x))) %>%
  select(-data)

modelsnoincumbent <- train_data_dem %>% 
  mutate(modelnoincumb = map(data, ~lm(dem_votes_major_percent ~ avg_rating, 
                                  data = .x))) %>%
  select(-data)

model_results_dem <- modelsdem %>% 
  mutate(r_squared = map_dbl(modeldem, ~summary(.x)$r.squared))

modelsnoincumbent_results <- modelsnoincumbent %>% 
  mutate(r_squared = map_dbl(modelnoincumb, ~summary(.x)$r.squared))

```

```{r}
#FUNDAMENTALS DATA 


```



```{r}
votedata <- read_csv("/Users/juliablank/Documents/GOV 50 PROJECTS/electionanalytics/Economic Section data/house_popvote_seats.csv")

pollsdata <- read_csv("~/Documents/GOV 50 PROJECTS/electionanalytics/03-Polling (9-22)/section data/polls_df.csv")

votedata <- votedata %>%
  mutate(incumbent_president = c("D","D","D","R","R","R","R","D","D","D","D","R","R","R","R","D","D","R","R","R","R","R", "R","D","D","D","D", "R", "R", "R","R","D","D","D","D","R","R")) %>%
  rename(Year = year) %>%
  select('Year','D_majorvote_pct', 'R_majorvote_pct', "winner_party", "H_incumbent_party", "incumbent_president")

pres_approval<- read_csv("/Users/juliablank/Documents/GOV 50 PROJECTS/electionanalytics/03-Polling (9-22)/section data/Other polling data/pres_approval_gallup_1941-2022.csv")

pres_approval <- pres_approval
  

pollsdata <- pollsdata %>%
  filter(days_until_election<70) %>%
  group_by(year, party) %>%
  summarise(avgsupport=mean(support)) %>%
  rename(Year = year)

RDI_quarterly <- read_csv("~/Documents/GOV 50 PROJECTS/electionanalytics/Economic Section data/RDI_quarterly.csv") 

RDI_quarterly <- RDI_quarterly %>%
  filter(quarter_cycle == 7) %>%
  select('year', "DSPIC_change_pct", 'quarter_cycle') %>%
  rename(Year = year)

alldata <- votedata%>%
  full_join(pollsdata) %>%
  left_join(RDI_quarterly)
  
alldata <- alldata %>%
  mutate(dem_incumbent_pres = case_when(incumbent_president == 'D' ~ 1,
                                        TRUE ~ 0)) %>%
  group_by(Year) %>%
  drop_na()
  
alldata_dem <-  alldata %>%
  filter(party== 'D') %>% 
  mutate(midterm = ifelse(Year %% 4, 1, 0))

```

```{r}
#finaldata <- left_join(votedata, pollsdata, by = "Year") %>% 
  #full_join(avg_ratings, by = "Year") %>%
  #mutate(dem_incumbent_pres = case_when(incumbent_president == 'D' ~ 1,                                     TRUE ~ 0)) #%>%
  


#just rdi 

rdi <- lm(D_majorvote_pct ~ DSPIC_change_pct , alldata_dem)

pollsonly <- lm(D_majorvote_pct ~ avgsupport, alldata_dem)

fundamentals <- lm(D_majorvote_pct ~ avgsupport + DSPIC_change_pct + dem_incumbent_pres, alldata_dem)

midtermfundamentals <- lm(D_majorvote_pct ~ avgsupport + DSPIC_change_pct + dem_incumbent_pres + midterm, alldata_dem)

incumbency <- lm(D_majorvote_pct ~ dem_incumbent_pres + midterm, alldata_dem)

stargazer(incumbency, type = "text")

stargazer(rdi, incumbency, pollsonly, fundamentals, midtermfundamentals, type = "text",  title="Fundamentals Regression Results", dep.var.labels = "Democratic Vote Percentage",
          column.labels	= c("RDI", "Incumbency", "Polls", "Fundamentals", "Midterm Fundamentals"),
          covariate.labels = c("% Change in RDI", "Incumbent Dem President", "Midterm", "Average Poll Support")
)

 # filter(Year > 2009) %>%
  #group_by(Year) %>%
  #mutate(demvotes = mean(D_majorvote_pct)) %>%
 #summarize(demvotes)
```

```{r}
expert_ratings

avg_ratings <- expert_ratings %>% 
  select(year, state, district, avg_rating) %>%
  rename(Year = year) %>%
  group_by(Year, state) %>%
  summarize(avg_stat_rating = mean(avg_rating))
```




Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
